<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#0a0a0a" />
    <title>Bluesky Low Data – Post</title>
    <base href="./" />
    <link rel="preconnect" href="https://public.api.bsky.app" crossorigin>
    <link rel="manifest" href="manifest.webmanifest" />
    <link rel="icon" href="icons/icon-192.png" sizes="192x192" />
    <link rel="apple-touch-icon" href="icons/icon-192.png" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header class="app-header">
      <div class="brand">
        <span class="dot"></span>
        <h1>Bluesky Low Data</h1>
      </div>
      <nav class="nav">
        <button id="btn-install" class="secondary" hidden>Install</button>
        <button id="btn-logout" class="secondary" hidden>Log out</button>
      </nav>
    </header>

    <main class="container">
      <section id="login-section" class="card">
        <h2>Log in</h2>
        <div class="tabs">
          <button class="tab" data-tab="oauth">OAuth</button>
          <button class="tab active" data-tab="apppw">App password</button>
        </div>

        <div id="tab-oauth" class="tab-panel">
          <form id="form-oauth" class="grid">
            <label class="full">
              <span>Handle (@username)</span>
              <input id="oauth-handle" type="text" inputmode="email" placeholder="@you.bsky.social" autocomplete="username" required />
            </label>
            <label class="full">
              <span>Redirect URI</span>
              <input id="oauth-redirect" type="url" value="" required />
              <small>Defaults to this site's <code>oauth-callback.html</code></small>
            </label>
            <div class="row">
              <button id="btn-oauth-start" type="submit">Continue with Bluesky</button>
            </div>
            <p class="muted small">Standards-based login using PKCE, PAR and DPoP. Experimental in browsers.</p>
          </form>
        </div>

        <div id="tab-apppw" class="tab-panel active">
          <form id="form-apppw" class="grid">
            <label class="full">
              <span>Handle or DID</span>
              <input id="apppw-identifier" type="text" inputmode="email" placeholder="@you.bsky.social" autocomplete="username" required />
            </label>
            <label class="full">
              <span>App password</span>
              <input id="apppw-password" type="password" placeholder="xxxx-xxxx-xxxx-xxxx" autocomplete="current-password" required />
            </label>
            <div class="row">
              <button id="btn-apppw-login" type="submit">Log in</button>
            </div>
            <p class="muted small">Use a Bluesky <em>App Password</em>, not your main account password.</p>
          </form>
        </div>
      </section>

      <section id="session-section" class="card" hidden>
        <div class="session-row">
          <div>
            <div class="muted small">Signed in as</div>
            <div id="session-identity" class="identity">—</div>
          </div>
          <div class="muted small" id="pds-host">—</div>
        </div>
      </section>

      <section id="composer" class="card" hidden>
        <h2>Compose</h2>
        <form id="form-compose" class="grid">
          <label class="full">
            <span>Text</span>
            <textarea id="post-text" rows="5" maxlength="1200" placeholder="What's happening?" required></textarea>
            <div class="row between small muted">
              <span>Links and #hashtags will be faceted automatically.</span>
              <span><span id="byte-count">0</span>/300 bytes</span>
            </div>
          </label>

          <fieldset class="full">
            <legend>Images (up to 4)</legend>
            <input id="image-input" type="file" accept="image/*" multiple />
            <div class="row small muted">
              <label><input id="compress-toggle" type="checkbox" checked /> Compress before upload</label>
              <label>Max side <input id="max-dim" type="number" value="1600" min="512" max="4096" step="64" /> px</label>
              <label>Quality <input id="quality" type="range" min="0.5" max="0.95" step="0.05" value="0.85" /></label>
            </div>
            <div id="image-list" class="image-list"></div>
          </fieldset>

          <details class="full">
            <summary>Reply (thread) options</summary>
            <div class="grid">
              <label class="full"><span>Parent post URI</span><input id="reply-parent-uri" type="text" placeholder="at://did:.../app.bsky.feed.post/..." /></label>
              <label class="full"><span>Parent post CID</span><input id="reply-parent-cid" type="text" placeholder="bafy..." /></label>
              <label class="full"><span>Root post URI (optional)</span><input id="reply-root-uri" type="text" placeholder="at://did:.../app.bsky.feed.post/..." /></label>
              <label class="full"><span>Root post CID (optional)</span><input id="reply-root-cid" type="text" placeholder="bafy..." /></label>
            </div>
          </details>

          <div class="row">
            <button id="btn-post" type="submit">Post</button>
          </div>
        </form>
        <output id="post-result" class="small"></output>
      </section>
    </main>

    <footer class="footer">
      <div class="container row between">
        <span class="muted small">Fast, privacy-friendly, no tracking. PWA installable.</span>
        <a class="small" href="https://docs.bsky.app" target="_blank" rel="noopener">Bluesky docs</a>
      </div>
    </footer>

    <script src="app.js" type="module"></script>
    <script>
      // Register service worker
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('service-worker.js').catch(console.warn);
        });
      }
    </script>
  </body>
</html>
